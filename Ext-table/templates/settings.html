<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Settings - Extraction Table Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-gear-fill"></i> Sample Settings
                </h1>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-upload"></i> Upload & Process
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/settings">
                            <i class="bi bi-gear"></i> Settings
                        </a>
                    </li>
                </ul>

                <!-- Current Settings Summary -->
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle-fill"></i> Current Settings Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-droplet-fill text-info"></i> H2O Settings</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Status:</strong> <span id="currentH2OStatus" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>H2O Count:</strong> <span id="currentH2OCount" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>Position Preference:</strong> <span id="currentH2OPreference" class="badge bg-secondary">Loading...</span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-grid-3x3-gap-fill text-warning"></i> Processing Settings</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Samples per Pool:</strong> <span id="currentSamplesPerPool" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>Sample ID Pattern:</strong> <span id="currentSamplePattern" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>Prefix Mappings:</strong> <span id="currentPrefixCount" class="badge bg-secondary">Loading...</span></li>
                                </ul>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6><i class="bi bi-collection-fill text-success"></i> Sample Types</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Pool Samples:</strong> <span id="currentPoolCount" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>No Pool Samples:</strong> <span id="currentNoPoolCount" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>ANA Samples:</strong> <span id="currentAnacount" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>SAL Samples:</strong> <span id="currentSalCount" class="badge bg-secondary">Loading...</span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-virus-fill text-danger"></i> Tissue Types</h6>
                                <ul class="list-unstyled">
                                    <li><strong>TIS Samples:</strong> <span id="currentTisCount" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>INT Samples:</strong> <span id="currentIntCount" class="badge bg-secondary">Loading...</span></li>
                                    <li><strong>PT Samples:</strong> <span id="currentPtCount" class="badge bg-secondary">Loading...</span></li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-lightbulb-fill"></i> 
                            <strong>Quick Guide:</strong> Check this summary to see current settings. Items in <span class="badge bg-warning">yellow</span> need attention, <span class="badge bg-success">green</span> are configured, <span class="badge bg-secondary">gray</span> are using defaults.
                        </div>
                    </div>
                </div>

                <form id="settingsForm">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-arrow-left-right"></i> Prefix Mapping
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Map original sample prefixes to new prefixes (e.g., CANB_ANA25 -> BA25)</p>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> <strong>Current mappings:</strong> <span id="currentPrefixMappings">Loading...</span>
                            </div>
                            <div id="prefixMapping">
                                <div class="row mb-2">
                                    <div class="col-md-5">
                                        <label class="form-label">Original Prefix</label>
                                        <input type="text" class="form-control" placeholder="e.g., CANB_ANA25" name="original_prefix[]">
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label">New Prefix</label>
                                        <input type="text" class="form-control" placeholder="e.g., BA25" name="new_prefix[]">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label><br>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMapping(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMapping()">
                                <i class="bi bi-plus"></i> Add Mapping
                            </button>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-database-fill"></i> Pool Samples
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Samples that should be pooled (each gets its own pool)</p>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> <strong>Current pool samples:</strong> <span id="currentPoolSamplesList">Loading...</span>
                            </div>
                            <div id="poolSamples">
                                <div class="row mb-2">
                                    <div class="col-md-10">
                                        <input type="text" class="form-control" placeholder="e.g., CANB_ANA25_001" name="pool_sample[]">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePoolSample(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPoolSample()">
                                <i class="bi bi-plus"></i> Add Pool Sample
                            </button>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-database"></i> No Pool Samples
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Samples that should NOT be pooled (marked as "Not Pool")</p>
                            <div id="noPoolSamples">
                                <div class="row mb-2">
                                    <div class="col-md-10">
                                        <input type="text" class="form-control" placeholder="e.g., CANB_TIS25_001" name="no_pool_sample[]">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeNoPoolSample(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addNoPoolSample()">
                                <i class="bi bi-plus"></i> Add No Pool Sample
                            </button>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-tags"></i> Sample Type Classification
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Define which prefixes belong to each sample type (only these will be processed)</p>
                            
                            <!-- ANA Samples -->
                            <div class="mb-4">
                                <h6 class="text-primary">ANA Samples</h6>
                                <div id="anaSamples">
                                    <div class="row mb-2">
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" placeholder="e.g., CANB_ANAL23" name="ana_sample[]">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAnaSample(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAnaSample()">
                                    <i class="bi bi-plus"></i> Add ANA Sample
                                </button>
                            </div>
                            
                            <!-- SAL Samples -->
                            <div class="mb-4">
                                <h6 class="text-success">SAL Samples</h6>
                                <div id="salSamples">
                                    <div class="row mb-2">
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" placeholder="e.g., CANB_SAL23" name="sal_sample[]">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSalSample(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSalSample()">
                                    <i class="bi bi-plus"></i> Add SAL Sample
                                </button>
                            </div>
                            
                            <!-- PT Samples -->
                            <div class="mb-4">
                                <h6 class="text-warning">PT Samples</h6>
                                <div id="ptSamples">
                                    <div class="row mb-2">
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" placeholder="e.g., CANB_PT23" name="pt_sample[]">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePtSample(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPtSample()">
                                    <i class="bi bi-plus"></i> Add PT Sample
                                </button>
                            </div>
                            
                            <!-- TIS Samples -->
                            <div class="mb-4">
                                <h6 class="text-info">TIS Samples</h6>
                                <div id="tisSamples">
                                    <div class="row mb-2">
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" placeholder="e.g., CANB_TIS23" name="tis_sample[]">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTisSample(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addTisSample()">
                                    <i class="bi bi-plus"></i> Add TIS Sample
                                </button>
                            </div>
                            
                            <!-- INT Samples -->
                            <div class="mb-4">
                                <h6 class="text-secondary">INT Samples</h6>
                                <div id="intSamples">
                                    <div class="row mb-2">
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" placeholder="e.g., CANB_INT23" name="int_sample[]">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeIntSample(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addIntSample()">
                                    <i class="bi bi-plus"></i> Add INT Sample
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-sliders"></i> Processing Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="samplesPerPool" class="form-label">Samples per Pool (Auto-pooling)</label>
                                    <input type="number" class="form-control" id="samplesPerPool" name="samples_per_pool" value="" min="1" max="20">
                                    <div class="form-text">Number of samples to group together for auto-pooling</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="sampleIdPattern" class="form-label">Sample ID Pattern</label>
                                    <input type="text" class="form-control" id="sampleIdPattern" name="sample_id_pattern" value="">
                                    <div class="form-text">Regex pattern for parsing sample IDs</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-droplet-half"></i> H2O Random Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Configure H2O random placement in tables (will be used consistently across Extraction, PCR, and cDNA tables)</p>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="enableH2ORandom" name="enable_h2o_random">
                                        <label class="form-check-label" for="enableH2ORandom">
                                            Enable H2O Random Placement
                                        </label>
                                    </div>
                                    <div class="form-text">When enabled, randomly places H2O in available positions</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="h2oCount" class="form-label">Number of H2O per plate</label>
                                    <input type="number" class="form-control" id="h2oCount" name="h2o_count" value="2" min="1" max="10">
                                    <div class="form-text">How many H2O samples to place randomly in each plate</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <label class="form-label">H2O Position Preference</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="h2o_position_preference" id="h2oRandom" value="random" checked>
                                        <label class="form-check-label" for="h2oRandom">
                                            Completely Random
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="h2o_position_preference" id="h2oEdges" value="edges">
                                        <label class="form-check-label" for="h2oEdges">
                                            Prefer Edge Positions
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="h2o_position_preference" id="h2oCenter" value="center">
                                        <label class="form-check-label" for="h2oCenter">
                                            Prefer Center Positions
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <button type="button" class="btn btn-primary me-2" onclick="saveSettings()">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportSettings()">
                            <i class="bi bi-download"></i> Export Settings
                        </button>
                        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importSettings()">
                        <button type="button" class="btn btn-info" onclick="document.getElementById('importFile').click()">
                            <i class="bi bi-upload"></i> Import Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        function addMapping(original = '', new_prefix = '') {
            const container = document.getElementById('prefixMapping');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="e.g., CANB_ANA25" name="original_prefix[]" value="${original}">
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="e.g., BA25" name="new_prefix[]" value="${new_prefix}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMapping(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeMapping(button) {
            button.closest('.row').remove();
        }

        function addPoolSample(sample = '') {
            const container = document.getElementById('poolSamples');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="e.g., CANB_ANA25_001" name="pool_sample[]" value="${sample}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePoolSample(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function removePoolSample(button) {
            button.closest('.row').remove();
        }

        function addNoPoolSample(sample = '') {
            const container = document.getElementById('noPoolSamples');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="e.g., CANB_TIS25_001" name="no_pool_sample[]" value="${sample}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeNoPoolSample(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeNoPoolSample(button) {
            button.closest('.row').remove();
        }

        // ANA Sample functions
        function addAnaSample(sample = '') {
            const container = document.getElementById('anaSamples');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="e.g., CANB_ANAL23" name="ana_sample[]" value="${sample}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAnaSample(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeAnaSample(button) {
            button.closest('.row').remove();
        }

        // SAL Sample functions
        function addSalSample(sample = '') {
            const container = document.getElementById('salSamples');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="e.g., CANB_SAL23" name="sal_sample[]" value="${sample}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSalSample(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeSalSample(button) {
            button.closest('.row').remove();
        }

        // PT Sample functions
        function addPtSample(sample = '') {
            const container = document.getElementById('ptSamples');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="e.g., CANB_PT23" name="pt_sample[]" value="${sample}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePtSample(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function removePtSample(button) {
            button.closest('.row').remove();
        }

        // TIS Sample functions
        function addTisSample(sample = '') {
            const container = document.getElementById('tisSamples');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="e.g., CANB_TIS23" name="tis_sample[]" value="${sample}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTisSample(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeTisSample(button) {
            button.closest('.row').remove();
        }

        // INT Sample functions
        function addIntSample(sample = '') {
            const container = document.getElementById('intSamples');
            const div = document.createElement('div');
            div.className = 'row mb-2';
            div.innerHTML = `
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="e.g., CANB_INT23" name="int_sample[]" value="${sample}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeIntSample(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeIntSample(button) {
            button.closest('.row').remove();
        }

        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    // Clear existing fields
                    document.getElementById('prefixMapping').innerHTML = '';
                    // Load prefix mapping
                    const prefixMappingDiv = document.getElementById('prefixMapping');
                    prefixMappingDiv.innerHTML = ''; // Clear existing
                    for (const [original, new_prefix] of Object.entries(data.prefix_mapping || {})) {
                        addMapping(original, new_prefix);
                    }

                    // Load pool samples
                    const poolSamplesDiv = document.getElementById('poolSamples');
                    poolSamplesDiv.innerHTML = ''; // Clear existing
                    (data.pool_samples || []).forEach(sample => addPoolSample(sample));

                    // Load no pool samples
                    const noPoolSamplesDiv = document.getElementById('noPoolSamples');
                    noPoolSamplesDiv.innerHTML = ''; // Clear existing
                    (data.no_pool_samples || []).forEach(sample => addNoPoolSample(sample));

                    // Load sample type classifications
                    const anaSamplesDiv = document.getElementById('anaSamples');
                    anaSamplesDiv.innerHTML = ''; // Clear existing
                    (data.ana_samples || []).forEach(sample => addAnaSample(sample));

                    const salSamplesDiv = document.getElementById('salSamples');
                    salSamplesDiv.innerHTML = ''; // Clear existing
                    (data.sal_samples || []).forEach(sample => addSalSample(sample));

                    const ptSamplesDiv = document.getElementById('ptSamples');
                    ptSamplesDiv.innerHTML = ''; // Clear existing
                    (data.pt_samples || []).forEach(sample => addPtSample(sample));

                    const tisSamplesDiv = document.getElementById('tisSamples');
                    tisSamplesDiv.innerHTML = ''; // Clear existing
                    (data.tis_samples || []).forEach(sample => addTisSample(sample));

                    const intSamplesDiv = document.getElementById('intSamples');
                    intSamplesDiv.innerHTML = ''; // Clear existing
                    (data.int_samples || []).forEach(sample => addIntSample(sample));

                    // Load processing settings
                    if (data.samples_per_pool !== undefined) {
                        document.getElementById('samplesPerPool').value = data.samples_per_pool;
                    } else {
                        document.getElementById('samplesPerPool').value = '';
                    }
                    if (data.sample_id_pattern !== undefined) {
                        document.getElementById('sampleIdPattern').value = data.sample_id_pattern;
                    } else {
                        document.getElementById('sampleIdPattern').value = '';
                    }

                    // Load H2O settings
                    if (data.enable_h2o_random !== undefined) {
                        document.getElementById('enableH2ORandom').checked = data.enable_h2o_random;
                    } else {
                        document.getElementById('enableH2ORandom').checked = false;
                    }
                    if (data.h2o_count !== undefined) {
                        document.getElementById('h2oCount').value = data.h2o_count;
                    } else {
                        document.getElementById('h2oCount').value = '2';
                    }
                    if (data.h2o_position_preference !== undefined) {
                        const radioButtons = document.getElementsByName('h2o_position_preference');
                        for (const radio of radioButtons) {
                            radio.checked = radio.value === data.h2o_position_preference;
                        }
                    } else {
                        document.getElementById('h2oRandom').checked = true;
                    }
                    
                    // Update the settings summary
                    updateSettingsSummary(data);
                    
                    // Update current value displays in form sections
                    const prefixMappings = Object.entries(data.prefix_mapping || {});
                    document.getElementById('currentPrefixMappings').textContent = 
                        prefixMappings.length > 0 ? prefixMappings.map(([orig, new_p]) => `${orig} â†’ ${new_p}`).join(', ') : 'None configured';
                    
                    const poolSamples = data.pool_samples || [];
                    document.getElementById('currentPoolSamplesList').textContent = 
                        poolSamples.length > 0 ? poolSamples.join(', ') : 'None configured';
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                });
        }

        function saveSettings() {
            const formData = new FormData(document.getElementById('settingsForm'));
            
            const settings = {
                prefix_mapping: {},
                pool_samples: [],
                no_pool_samples: [],
                samples_per_pool: parseInt(document.getElementById('samplesPerPool').value),
                sample_id_pattern: document.getElementById('sampleIdPattern').value,
                ana_samples: [],
                sal_samples: [],
                pt_samples: [],
                tis_samples: [],
                int_samples: [],
                enable_h2o_random: document.getElementById('enableH2ORandom').checked,
                h2o_count: parseInt(document.getElementById('h2oCount').value),
                h2o_position_preference: document.querySelector('input[name="h2o_position_preference"]:checked').value
            };

            // Collect prefix mapping
            const originalPrefixes = formData.getAll('original_prefix[]');
            const newPrefixes = formData.getAll('new_prefix[]');
            for (let i = 0; i < originalPrefixes.length; i++) {
                if (originalPrefixes[i] && newPrefixes[i]) {
                    settings.prefix_mapping[originalPrefixes[i]] = newPrefixes[i];
                }
            }

            // Collect pool samples
            settings.pool_samples = formData.getAll('pool_sample[]').filter(s => s.trim() !== '');

            // Collect no pool samples
            settings.no_pool_samples = formData.getAll('no_pool_sample[]').filter(s => s.trim() !== '');

            // Collect sample type classifications
            settings.ana_samples = formData.getAll('ana_sample[]').filter(s => s.trim() !== '');
            settings.sal_samples = formData.getAll('sal_sample[]').filter(s => s.trim() !== '');
            settings.pt_samples = formData.getAll('pt_sample[]').filter(s => s.trim() !== '');
            settings.tis_samples = formData.getAll('tis_sample[]').filter(s => s.trim() !== '');
            settings.int_samples = formData.getAll('int_sample[]').filter(s => s.trim() !== '');

            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Error saving settings: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            });
        }

        function exportSettings() {
            const settings = {
                prefix_mapping: {},
                pool_samples: [],
                no_pool_samples: [],
                samples_per_pool: parseInt(document.getElementById('samplesPerPool').value),
                sample_id_pattern: document.getElementById('sampleIdPattern').value,
                enable_h2o_random: document.getElementById('enableH2ORandom').checked,
                h2o_count: parseInt(document.getElementById('h2oCount').value),
                h2o_position_preference: document.querySelector('input[name="h2o_position_preference"]:checked').value
            };

            // Collect current form data
            const formData = new FormData(document.getElementById('settingsForm'));
            
            // Collect prefix mapping
            const originalPrefixes = formData.getAll('original_prefix[]');
            const newPrefixes = formData.getAll('new_prefix[]');
            for (let i = 0; i < originalPrefixes.length; i++) {
                if (originalPrefixes[i] && newPrefixes[i]) {
                    settings.prefix_mapping[originalPrefixes[i]] = newPrefixes[i];
                }
            }

            // Collect pool samples
            settings.pool_samples = formData.getAll('pool_sample[]').filter(s => s.trim() !== '');

            // Collect no pool samples
            settings.no_pool_samples = formData.getAll('no_pool_sample[]').filter(s => s.trim() !== '');

            // Download as JSON file
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_settings.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importSettings() {
            const file = document.getElementById('importFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const settings = JSON.parse(e.target.result);
                        
                        // Clear existing fields
                        document.getElementById('prefixMapping').innerHTML = '';
                        document.getElementById('poolSamples').innerHTML = '';
                        document.getElementById('noPoolSamples').innerHTML = '';

                        // Load imported prefix mapping
                        for (const [original, new_prefix] of Object.entries(settings.prefix_mapping || {})) {
                            addMapping(original, new_prefix);
                        }

                        // Load imported pool samples
                        (settings.pool_samples || []).forEach(sample => addPoolSample(sample));

                        // Load imported no pool samples
                        (settings.no_pool_samples || []).forEach(sample => addNoPoolSample(sample));

                        // Load other settings (no defaults)
                        if (settings.samples_per_pool !== undefined) {
                            document.getElementById('samplesPerPool').value = settings.samples_per_pool;
                        } else {
                            document.getElementById('samplesPerPool').value = '';
                        }
                        if (settings.sample_id_pattern !== undefined) {
                            document.getElementById('sampleIdPattern').value = settings.sample_id_pattern;
                        } else {
                            document.getElementById('sampleIdPattern').value = '';
                        }
                        
                        // Load H2O settings
                        if (settings.enable_h2o_random !== undefined) {
                            document.getElementById('enableH2ORandom').checked = settings.enable_h2o_random;
                        } else {
                            document.getElementById('enableH2ORandom').checked = false;
                        }
                        if (settings.h2o_count !== undefined) {
                            document.getElementById('h2oCount').value = settings.h2o_count;
                        } else {
                            document.getElementById('h2oCount').value = '2';
                        }
                        if (settings.h2o_position_preference !== undefined) {
                            const radioButtons = document.getElementsByName('h2o_position_preference');
                            for (const radio of radioButtons) {
                                radio.checked = radio.value === settings.h2o_position_preference;
                            }
                        } else {
                            document.getElementById('h2oRandom').checked = true;
                        }
                        
                        alert('Settings imported successfully!');
                    } catch (error) {
                        alert('Error importing settings: Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            }
        }

        function updateSettingsSummary(settings) {
            // H2O Settings
            const h2oEnabled = settings.enable_h2o_random || false;
            document.getElementById('currentH2OStatus').textContent = h2oEnabled ? 'Enabled' : 'Disabled';
            document.getElementById('currentH2OStatus').className = h2oEnabled ? 'badge bg-success' : 'badge bg-secondary';
            
            const h2oCount = settings.h2o_count || 2;
            document.getElementById('currentH2OCount').textContent = h2oCount;
            document.getElementById('currentH2OCount').className = h2oCount > 0 ? 'badge bg-info' : 'badge bg-warning';
            
            const h2oPreference = settings.h2o_position_preference || 'random';
            document.getElementById('currentH2OPreference').textContent = h2oPreference.charAt(0).toUpperCase() + h2oPreference.slice(1);
            document.getElementById('currentH2OPreference').className = 'badge bg-info';
            
            // Processing Settings
            const samplesPerPool = settings.samples_per_pool || 'Not set';
            document.getElementById('currentSamplesPerPool').textContent = samplesPerPool;
            document.getElementById('currentSamplesPerPool').className = samplesPerPool !== 'Not set' ? 'badge bg-success' : 'badge bg-warning';
            
            const samplePattern = settings.sample_id_pattern || 'Not set';
            document.getElementById('currentSamplePattern').textContent = samplePattern.length > 20 ? samplePattern.substring(0, 20) + '...' : samplePattern;
            document.getElementById('currentSamplePattern').className = samplePattern !== 'Not set' ? 'badge bg-success' : 'badge bg-warning';
            
            const prefixCount = Object.keys(settings.prefix_mapping || {}).length;
            document.getElementById('currentPrefixCount').textContent = prefixCount;
            document.getElementById('currentPrefixCount').className = prefixCount > 0 ? 'badge bg-success' : 'badge bg-warning';
            
            // Sample Types
            const poolCount = (settings.pool_samples || []).length;
            document.getElementById('currentPoolCount').textContent = poolCount;
            document.getElementById('currentPoolCount').className = poolCount > 0 ? 'badge bg-success' : 'badge bg-secondary';
            
            const noPoolCount = (settings.no_pool_samples || []).length;
            document.getElementById('currentNoPoolCount').textContent = noPoolCount;
            document.getElementById('currentNoPoolCount').className = noPoolCount > 0 ? 'badge bg-success' : 'badge bg-secondary';
            
            const anaCount = (settings.ana_samples || []).length;
            document.getElementById('currentAnacount').textContent = anaCount;
            document.getElementById('currentAnacount').className = anaCount > 0 ? 'badge bg-success' : 'badge bg-secondary';
            
            const salCount = (settings.sal_samples || []).length;
            document.getElementById('currentSalCount').textContent = salCount;
            document.getElementById('currentSalCount').className = salCount > 0 ? 'badge bg-success' : 'badge bg-secondary';
            
            // Tissue Types
            const tisCount = (settings.tis_samples || []).length;
            document.getElementById('currentTisCount').textContent = tisCount;
            document.getElementById('currentTisCount').className = tisCount > 0 ? 'badge bg-success' : 'badge bg-secondary';
            
            const intCount = (settings.int_samples || []).length;
            document.getElementById('currentIntCount').textContent = intCount;
            document.getElementById('currentIntCount').className = intCount > 0 ? 'badge bg-success' : 'badge bg-secondary';
            
            const ptCount = (settings.pt_samples || []).length;
            document.getElementById('currentPtCount').textContent = ptCount;
            document.getElementById('currentPtCount').className = ptCount > 0 ? 'badge bg-success' : 'badge bg-secondary';
        }

        // Load settings when page loads
        window.onload = function() {
            loadSettings();
        };
    </script>
</body>
</html>
