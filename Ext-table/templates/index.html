<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extraction Table Generator - Web Version</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563EB;
            --secondary-color: #3B82F6;
            --light-bg: #EFF6FF;
            --white-bg: #FFFFFF;
            --border-color: #BFDBFE;
            --text-primary: #1E3A8A;
            --text-secondary: #4B5563;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 1rem 1rem;
        }

        .card {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: var(--white-bg);
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .sheet-card {
            background-color: var(--white-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
        }

        .sheet-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .sheet-checkbox {
            margin-right: 0.5rem;
        }

        .column-list {
            background-color: #F9FAFB;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-left: 1.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .column-item {
            display: flex;
            align-items: center;
            padding: 0.25rem 0;
        }

        .progress-container {
            margin: 1rem 0;
        }

        .log-container {
            background-color: #1E293B;
            color: #E2E8F0;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .file-preview {
            max-height: 300px;
            overflow: auto;
        }

        .file-preview table {
            font-size: 0.875rem;
        }

        .hidden {
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 0.15rem;
        }

        .output-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .output-file:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0">
                        <i class="bi bi-table"></i>
                        Extraction Table Generator
                    </h1>
                    <p class="mb-0 mt-2">Web Version - Process Excel files for sample extraction</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="/">
                    <i class="bi bi-upload"></i> Upload & Process
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/settings">
                    <i class="bi bi-gear"></i> Settings
                </a>
            </li>
        </ul>
        <!-- File Upload Section -->
        <div class="row">
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-upload"></i> File Upload
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="sourceFile" class="form-label">Source Excel File</label>
                                <input type="file" class="form-control" id="sourceFile" name="source_file" 
                                       accept=".xlsx,.xls" required>
                                <div class="form-text">Select the Excel file containing sample data</div>
                            </div>
                            <div class="mb-3">
                                <label for="customOutput" class="form-label">Custom Output File (Optional)</label>
                                <input type="text" class="form-control" id="customOutput" name="custom_output" 
                                       placeholder="e.g., My_Extraction_Output">
                                <div class="form-text">Leave blank to use existing output file, or enter a custom filename</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="uploadBtn">
                                <i class="bi bi-cloud-upload"></i> Upload and Analyze
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Processing Controls -->
                <div class="card" id="processingCard" style="display: none;">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> Processing Controls
                    </div>
                    <div class="card-body">
                        <div class="progress-container">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="progressBar" role="progressbar" 
                                     style="width: 0%"></div>
                            </div>
                            <div class="mt-2">
                                <small id="progressMessage" class="text-muted"></small>
                            </div>
                        </div>
                        <button class="btn btn-success w-100" id="processBtn">
                            <i class="bi bi-play-circle"></i> Start Processing
                        </button>
                        <button class="btn btn-outline-danger w-100 mt-2" id="resetBtn">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- Log Output -->
                <div class="card" id="logCard" style="display: none;">
                    <div class="card-header">
                        <i class="bi bi-terminal"></i> Processing Log
                    </div>
                    <div class="card-body p-0">
                        <div class="log-container" id="logOutput"></div>
                    </div>
                </div>
            </div>

            <!-- Sheet Selection Section -->
            <div class="col-lg-8">
                <div class="card" id="sheetsCard" style="display: none;">
                    <div class="card-header">
                        <i class="bi bi-grid-3x3-gap"></i> Sheet and Column Selection
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Select the Excel sheets and columns to process:</p>
                        <div id="sheetsContainer"></div>
                    </div>
                </div>

                <!-- File Preview Section -->
                <div class="card" id="previewCard" style="display: none;">
                    <div class="card-header">
                        <i class="bi bi-eye"></i> File Preview
                    </div>
                    <div class="card-body">
                        <div class="file-preview" id="previewContainer"></div>
                    </div>
                </div>

                <!-- Output Files Section -->
                <div class="card" id="outputCard" style="display: none;">
                    <div class="card-header">
                        <i class="bi bi-download"></i> Output Files
                    </div>
                    <div class="card-body">
                        <div id="outputFiles"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Processing Complete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Your files have been processed successfully!</p>
                    <p>You can download the output files from the Output Files section below.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Error
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage">An error occurred during processing.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSourcePath = '';
        let currentDestPath = '';
        let progressInterval = null;

        // File upload
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.innerHTML;
            
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
            uploadBtn.disabled = true;
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentSourcePath = data.source_path;
                    currentDestPath = data.dest_path;
                    displaySheets(data.sheets);
                    showProcessingControls();
                    addToLog('File uploaded and analyzed successfully');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Upload failed: ' + error.message);
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        });

        // Display sheets and columns
        function displaySheets(sheets) {
            const container = document.getElementById('sheetsContainer');
            container.innerHTML = '';
            
            Object.entries(sheets).forEach(([sheetName, sheetData]) => {
                const sheetDiv = document.createElement('div');
                sheetDiv.className = 'sheet-card';
                sheetDiv.innerHTML = `
                    <div class="sheet-header">
                        <input type="checkbox" class="form-check-input sheet-checkbox me-2" 
                               id="sheet_${sheetName}" data-sheet="${sheetName}">
                        <label class="form-check-label fw-bold" for="sheet_${sheetName}">
                            <i class="bi bi-file-earmark-excel"></i> ${sheetName}
                        </label>
                    </div>
                    <div class="column-list hidden" id="columns_${sheetName}">
                        <div class="mb-2">
                            <input type="checkbox" class="form-check-input select-all" 
                                   id="selectAll_${sheetName}">
                            <label class="form-check-label text-primary fw-bold" 
                                   for="selectAll_${sheetName}">Select All Columns</label>
                        </div>
                        ${sheetData.columns.map((col, idx) => `
                            <div class="column-item">
                                <input type="checkbox" class="form-check-input column-checkbox" 
                                       id="col_${sheetName}_${idx}" data-column="${idx}">
                                <label class="form-check-label" for="col_${sheetName}_${idx}">${col}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(sheetDiv);
                
                // Add event listeners
                const sheetCheckbox = sheetDiv.querySelector('.sheet-checkbox');
                const columnList = sheetDiv.querySelector('.column-list');
                const selectAllCheckbox = sheetDiv.querySelector('.select-all');
                const columnCheckboxes = sheetDiv.querySelectorAll('.column-checkbox');
                
                sheetCheckbox.addEventListener('change', function() {
                    columnList.classList.toggle('hidden', !this.checked);
                    if (!this.checked) {
                        selectAllCheckbox.checked = false;
                        columnCheckboxes.forEach(cb => cb.checked = false);
                    }
                });
                
                selectAllCheckbox.addEventListener('change', function() {
                    columnCheckboxes.forEach(cb => cb.checked = this.checked);
                });
                
                // Show preview on first sheet
                if (Object.keys(sheets)[0] === sheetName) {
                    showPreview(sheetName, sheetData.preview);
                }
            });
            
            document.getElementById('sheetsCard').style.display = 'block';
        }

        // Show file preview
        function showPreview(sheetName, preview) {
            const container = document.getElementById('previewContainer');
            container.innerHTML = `
                <h6>Preview: ${sheetName}</h6>
                ${preview}
            `;
            document.getElementById('previewCard').style.display = 'block';
        }

        // Show processing controls
        function showProcessingControls() {
            document.getElementById('processingCard').style.display = 'block';
            document.getElementById('logCard').style.display = 'block';
        }

        // Start processing
        document.getElementById('processBtn').addEventListener('click', async function() {
            const sheetsInfo = getSelectedSheets();
            
            if (Object.keys(sheetsInfo).length === 0) {
                showError('Please select at least one sheet and column');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_path: currentSourcePath,
                        dest_path: currentDestPath,
                        sheets_info: sheetsInfo
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    startProgressMonitoring();
                    addToLog('Processing started...');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Processing failed: ' + error.message);
            }
        });

        // Get selected sheets and columns
        function getSelectedSheets() {
            const sheetsInfo = {};
            
            document.querySelectorAll('.sheet-checkbox:checked').forEach(sheetCheckbox => {
                const sheetName = sheetCheckbox.dataset.sheet;
                const columns = [];
                
                document.querySelectorAll(`#columns_${sheetName} .column-checkbox:checked`).forEach(colCheckbox => {
                    columns.push(parseInt(colCheckbox.dataset.column));
                });
                
                if (columns.length > 0) {
                    sheetsInfo[sheetName] = columns;
                }
            });
            
            return sheetsInfo;
        }

        // Monitor progress
        function startProgressMonitoring() {
            progressInterval = setInterval(async function() {
                try {
                    const response = await fetch('/progress');
                    const progress = await response.json();
                    
                    updateProgress(progress);
                    
                    if (progress.status === 'completed') {
                        clearInterval(progressInterval);
                        showSuccess();
                        loadOutputFiles();
                    } else if (progress.status === 'error') {
                        clearInterval(progressInterval);
                        showError(progress.error);
                    }
                } catch (error) {
                    console.error('Error checking progress:', error);
                }
            }, 1000);
        }

        // Update progress display
        function updateProgress(progress) {
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressMessage = document.getElementById('progressMessage');
            
            progressBar.style.width = progress.progress + '%';
            progressPercent.textContent = progress.progress + '%';
            progressMessage.textContent = progress.message;
            
            if (progress.message) {
                addToLog(progress.message);
            }
            
            if (progress.error) {
                addToLog('ERROR: ' + progress.error);
            }
        }

        // Load output files
        async function loadOutputFiles() {
            try {
                const response = await fetch('/outputs');
                const data = await response.json();
                
                if (response.ok) {
                    displayOutputFiles(data.files);
                }
            } catch (error) {
                console.error('Error loading output files:', error);
            }
        }

        // Display output files
        function displayOutputFiles(files) {
            const container = document.getElementById('outputFiles');
            
            if (files.length === 0) {
                container.innerHTML = '<p class="text-muted">No output files available</p>';
            } else {
                container.innerHTML = files.map(file => `
                    <div class="output-file">
                        <div>
                            <i class="bi bi-file-earmark-excel text-success"></i>
                            <strong>${file.name}</strong>
                            <br>
                            <small class="text-muted">
                                Size: ${(file.size / 1024).toFixed(1)} KB | 
                                Modified: ${file.modified}
                            </small>
                        </div>
                        <a href="/download/${file.name}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-download"></i> Download
                        </a>
                    </div>
                `).join('');
            }
            
            document.getElementById('outputCard').style.display = 'block';
        }

        // Reset application
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset? All current data will be lost.')) {
                location.reload();
            }
        });

        // Add to log
        function addToLog(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // Show success modal
        function showSuccess() {
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
            
            // Reset process button
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Processing';
        }

        // Show error modal
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
            
            // Reset process button
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Processing';
        }

        // Load output files on page load
        window.addEventListener('load', loadOutputFiles);
    </script>
</body>
</html>
