{% extends "base.html" %}

{% block title %}Security Dashboard - HaoXai{% endblock %}

{% block extra_css %}
<style>
    /* Security Dashboard Modern Styling */
    .security-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Enhanced Page Header */
    .security-header {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 20px;
        padding: 24px 32px;
        margin-bottom: 24px;
        backdrop-filter: blur(10px);
    }

    .security-title {
        font-size: 28px;
        font-weight: 700;
        background: linear-gradient(135deg, #10b981 0%, #06b6d4 50%, #6366f1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .security-title i {
        font-size: 32px;
        background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .security-subtitle {
        color: var(--text-muted);
        font-size: 14px;
        font-weight: 500;
    }

    /* Stats Cards Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 28px;
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.9) 100%);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #10b981 0%, #06b6d4 50%, #6366f1 100%);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        border-color: rgba(99, 102, 241, 0.4);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 24px;
    }

    .stat-icon.users {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));
        color: #818cf8;
    }

    .stat-icon.active {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
        color: #4ade80;
    }

    .stat-icon.failed {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
        color: #f87171;
    }

    .stat-icon.backup {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
        color: #fbbf24;
    }

    .stat-icon.audit {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.1));
        color: #22d3ee;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #f8fafc 0%, #94a3b8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: block;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 13px;
        color: var(--text-muted);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Security Cards */
    .security-section-card {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.9) 100%);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .section-title-security {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title-security i {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .section-title-security i.users-icon {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
    }

    .section-title-security i.roles-icon {
        background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
        color: white;
    }

    .section-title-security i.audit-icon {
        background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        color: white;
    }

    .section-title-security i.backup-icon {
        background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
        color: white;
    }

    /* User List */
    .user-list-container {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 8px;
    }

    .user-list-container::-webkit-scrollbar {
        width: 6px;
    }

    .user-list-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .user-list-container::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.3);
        border-radius: 3px;
    }

    .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 12px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    .user-item:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.3);
        transform: translateX(4px);
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar-sm {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
    }

    .user-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
    }

    .user-email {
        font-size: 12px;
        color: var(--text-muted);
    }

    /* Role Badges */
    .role-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .role-badge-admin {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #f87171;
    }

    .role-badge-researcher {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #4ade80;
    }

    .role-badge-analyst {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: #60a5fa;
    }

    .role-badge-viewer {
        background: linear-gradient(135deg, rgba(107, 114, 128, 0.2) 0%, rgba(107, 114, 128, 0.1) 100%);
        border: 1px solid rgba(107, 114, 128, 0.3);
        color: #9ca3af;
    }

    /* Status Indicator */
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }

    .status-active {
        background: #22c55e;
        box-shadow: 0 0 8px #22c55e;
    }

    .status-inactive {
        background: #ef4444;
    }

    /* Audit Log Cards */
    .audit-container {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 8px;
    }

    .audit-card {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.6) 0%, rgba(30, 41, 59, 0.7) 100%);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 16px;
    }

    .audit-card:hover {
        border-color: rgba(99, 102, 241, 0.3);
        transform: translateX(4px);
    }

    .audit-icon-action {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

    .audit-icon-create {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
        color: #4ade80;
    }

    .audit-icon-update {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
        color: #fbbf24;
    }

    .audit-icon-delete {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
        color: #f87171;
    }

    .audit-icon-login {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.1));
        color: #22d3ee;
    }

    .audit-icon-failed {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
        color: #f87171;
    }

    .audit-icon-default {
        background: linear-gradient(135deg, rgba(148, 163, 184, 0.2), rgba(148, 163, 184, 0.1));
        color: #94a3b8;
    }

    .audit-content {
        flex: 1;
    }

    .audit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .audit-action-text {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
    }

    .audit-time {
        font-size: 12px;
        color: var(--text-muted);
    }

    .audit-details {
        font-size: 13px;
        color: var(--text-secondary);
    }

    .audit-user-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(99, 102, 241, 0.1);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        color: #818cf8;
        margin-top: 8px;
    }

    /* Buttons */
    .btn-security {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 600;
        font-size: 13px;
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-security:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        color: white;
    }

    .btn-refresh-security {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.3);
        color: #818cf8;
        border-radius: 10px;
        padding: 8px 16px;
        font-weight: 500;
        font-size: 13px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-refresh-security:hover {
        background: rgba(99, 102, 241, 0.2);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 48px 20px;
    }

    .empty-state i {
        font-size: 56px;
        color: var(--text-muted);
        opacity: 0.4;
        margin-bottom: 16px;
    }

    .empty-state h6 {
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Backup Cards */
    .backup-list-container {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 8px;
    }

    .backup-item-card {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.6) 0%, rgba(30, 41, 59, 0.7) 100%);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: all 0.3s ease;
    }

    .backup-item-card:hover {
        border-color: rgba(16, 185, 129, 0.3);
        transform: translateX(4px);
    }

    .backup-icon-bg {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .backup-icon-manual {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
        color: #4ade80;
    }

    .backup-icon-auto {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.1));
        color: #22d3ee;
    }

    .backup-icon-scheduled {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
        color: #fbbf24;
    }

    .backup-info-text {
        flex: 1;
    }

    .backup-filename {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
        margin-bottom: 4px;
    }

    .backup-meta {
        border-radius: 12px;
        text-transform: uppercase;
    }

    .backup-size {
        font-size: 11px;
        font-weight: 500;
        color: #6c757d;
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 12px;
    }

    .backup-actions {
        display: flex;
        gap: 8px;
    }

    .backup-card-body {
        padding: 12px 16px;
    }

    .backup-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .backup-stat {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #6c757d;
        font-weight: 500;
    }

    .backup-stat i {
        font-size: 14px;
        color: #495057;
    }

    /* Empty backup state styling */
    .empty-backup-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-backup-state .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.4;
    }

    .empty-backup-state h5 {
        color: #495057;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .empty-backup-state p {
        color: #6c757d;
        font-size: 14px;
        margin: 0;
    }

    /* Backup Controls and Status Styling */
    .backup-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .backup-status-display {
        margin-bottom: 16px;
    }

    .backup-status-display .alert {
        margin-bottom: 0;
        border-radius: 8px;
    }

    .backup-status-display .alert i {
        font-size: 16px;
    }

    .backup-status-display .alert strong {
        font-weight: 600;
    }

    .backup-status-display .alert small {
        opacity: 0.8;
    }

    .backup-item:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 security-container">
    <!-- Security Header -->
    <div class="security-header">
        <h1 class="security-title"><i class="bi bi-shield-check"></i> Security Dashboard</h1>
        <p class="security-subtitle">Manage database security, user access, and audit logs</p>
    </div>

    <!-- Security Statistics -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon users"><i class="bi bi-people"></i></div>
            <span class="stat-number" id="total-users">0</span>
            <span class="stat-label">Total Users</span>
        </div>
        <div class="stat-card">
            <div class="stat-icon active"><i class="bi bi-person-check"></i></div>
            <span class="stat-number" id="active-users">0</span>
            <span class="stat-label">Active Users</span>
        </div>
        <div class="stat-card">
            <div class="stat-icon failed"><i class="bi bi-shield-exclamation"></i></div>
            <span class="stat-number" id="failed-logins">0</span>
            <span class="stat-label">Failed Logins</span>
        </div>
        <div class="stat-card">
            <div class="stat-icon backup"><i class="bi bi-cloud-check"></i></div>
            <span class="stat-number" id="backups-count">0</span>
            <span class="stat-label">Backups Created</span>
        </div>
        <div class="stat-card">
            <div class="stat-icon audit"><i class="bi bi-clock-history"></i></div>
            <span class="stat-number" id="audit-count">0</span>
            <span class="stat-label">Audit Entries</span>
        </div>
    </div>

    <!-- User Management & Role Management Row -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="security-section-card">
                <div class="section-header">
                    <div class="section-title-security">
                        <i class="bi bi-people users-icon"></i> User Management
                    </div>
                    <a href="/admin/users" class="btn-security btn-sm">
                        <i class="bi bi-arrow-right"></i> Manage
                    </a>
                </div>
                <div class="user-list-container" id="user-list">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="security-section-card">
                <div class="section-header">
                    <div class="section-title-security">
                        <i class="bi bi-key roles-icon"></i> Role Management
                    </div>
                    <button class="btn-security btn-sm" onclick="showRoleModal()">
                        <i class="bi bi-shield-plus"></i> Add Role
                    </button>
                </div>
                <div class="role-list" id="role-list">
                    <!-- Roles will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Log -->
    <div class="security-section-card">
        <div class="section-header">
            <div class="section-title-security">
                <i class="bi bi-clock-history audit-icon"></i> Recent Audit Log
            </div>
            <div>
                <button class="btn-refresh-security" onclick="refreshAuditLog()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
        <div class="audit-container" id="audit-log">
            <!-- Audit log entries will be loaded here -->
        </div>
    </div>

    <!-- Database Management -->
    <div class="security-section-card">
        <div class="section-header">
            <div class="section-title-security">
                <i class="bi bi-database-add backup-icon"></i> Database Management
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <button class="btn-security mb-2" onclick="showInitModal()">
                    <i class="bi bi-plus-circle"></i> Create New Database
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn-refresh-security" onclick="showMigrateModal()">
                    <i class="bi bi-shield-check"></i> Add Security to Existing
                </button>
            </div>
        </div>

        <div id="database-status" class="alert alert-info d-flex align-items-center">
            <i class="bi bi-info-circle me-2"></i> Checking database security status...
        </div>
    </div>

    <!-- Backup Management -->
    <div class="security-section-card">
        <div class="section-header">
            <div class="section-title-security">
                <i class="bi bi-database backup-icon"></i> Backup Management
            </div>
            <button class="btn-security btn-sm" onclick="createBackup()">
                <i class="bi bi-cloud-download"></i> Create Backup
            </button>
        </div>

        <div id="backup-status" class="mb-3">
            <!-- Backup status will be loaded here -->
        </div>

        <div class="backup-list-container" id="backup-list">
            <!-- Backup entries will be loaded here -->
        </div>
    </div>
</div>

<!-- Database Init Modal -->
<div class="modal fade" id="initDatabaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Create New Secure Database</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="initDatabaseForm">
                    <div class="mb-3">
                        <label for="db_path" class="form-label">Database Path</label>
                        <input type="text" class="form-control" id="db_path" name="db_path" value="" required>
                        <small class="text-muted">Enter path for new database file</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Note:</strong> This will create a new database with full security features.
                        Any existing database at this path will be backed up first.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="initDatabase()">Create Database</button>
            </div>
        </div>
    </div>
</div>

<!-- Database Migrate Modal -->
<div class="modal fade" id="migrateDatabaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Add Security to Existing Database</h5>
                <button type="button" class="btn-close btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="migrateDatabaseForm">
                    <div class="mb-3">
                        <label for="migrate_db_path" class="form-label">Database Path</label>
                        <input type="text" class="form-control" id="migrate_db_path" name="db_path" value="" required>
                        <small class="text-muted">Enter path to existing database file</small>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Important:</strong> This will add security features to your existing database.
                        A backup will be created automatically before migration.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="migrateDatabase()">Add Security</button>
            </div>
        </div>
    </div>
</div>


<!-- Role Modal -->
<div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content"
            style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95)); border: 1px solid rgba(148, 163, 184, 0.2);">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title" id="roleModalTitle">Add Role</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="close"></button>
            </div>
            <div class="modal-body">
                <form id="roleForm">
                    <input type="hidden" id="edit_role_id">
                    <div class="mb-3">
                        <label for="role_name" class="form-label">Role Name</label>
                        <input type="text" class="form-control" id="role_name" required
                            style="background: rgba(15, 23, 42, 0.5); border-color: rgba(148, 163, 184, 0.2); color: white;">
                    </div>
                    <div class="mb-3">
                        <label for="role_description" class="form-label">Description</label>
                        <textarea class="form-control" id="role_description" rows="3"
                            style="background: rgba(15, 23, 42, 0.5); border-color: rgba(148, 163, 184, 0.2); color: white;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="permissions" class="form-label">Permissions (JSON array)</label>
                        <textarea class="form-control" id="permissions" rows="3"
                            style="background: rgba(15, 23, 42, 0.5); border-color: rgba(148, 163, 184, 0.2); color: white;">["READ", "WRITE"]</textarea>
                        <small class="text-muted">Available permissions: READ, WRITE, IMPORT, EXPORT, ANALYZE,
                            ALL</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRoleBtn" onclick="saveRole()">Save Role</button>
            </div>
        </div>
    </div>
</div>


<!-- JavaScript -->
<script>
    // Security Dashboard JavaScript
    let currentUser = null;

    // Initialize security dashboard
    document.addEventListener('DOMContentLoaded', function () {
        loadSecurityStats();
        loadUsers();
        loadRoles();
        loadAuditLog();
        loadBackups();
    });

    function loadSecurityStats() {
        console.log("ðŸ” Loading security stats...");
        fetch('/api/security/stats')
            .then(response => response.json())
            .then(data => {
                console.log("ðŸ“Š Security stats response:", data);

                document.getElementById('total-users').textContent = data.total_users || 0;
                document.getElementById('active-users').textContent = data.active_users || 0;
                document.getElementById('failed-logins').textContent = data.failed_logins || 0;
                document.getElementById('backups-count').textContent = data.backups_count || 0;
                document.getElementById('audit-count').textContent = data.audit_count || 0;

                console.log("âœ… Updated UI with:", {
                    totalUsers: data.total_users,
                    activeUsers: data.active_users,
                    failedLogins: data.failed_logins,
                    backupsCount: data.backups_count,
                    auditCount: data.audit_count
                });
            })
            .catch(error => {
                console.error('âŒ Error loading security stats:', error);
            });
    }

    function loadUsers() {
        fetch('/api/security/users')
            .then(response => response.json())
            .then(users => {
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';

                users.forEach(user => {
                    const roleBadgeClass = `role-badge-${user.role}`;

                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar-sm"><i class="bi bi-person"></i></div>
                        <div>
                            <div class="user-name">${user.username}</div>
                            <div class="user-email">${user.email}</div>
                        </div>
                    </div>
                    <div>
                        <span class="role-badge ${roleBadgeClass}">${user.role.toUpperCase()}</span>
                        <span class="status-dot ${user.is_active ? 'status-active' : 'status-inactive'}"></span>
                    </div>
                `;
                    userList.appendChild(userItem);
                });
            })
            .catch(error => console.error('Error loading users:', error));
    }

    function loadRoles() {
        const systemRoles = ['admin', 'researcher', 'viewer', 'analyst'];
        fetch('/api/security/roles')
            .then(response => response.json())
            .then(roles => {
                const roleList = document.getElementById('role-list');
                roleList.innerHTML = '';

                roles.forEach(role => {
                    const isSystemRole = systemRoles.includes(role.role_name);
                    const roleItem = document.createElement('div');
                    roleItem.className = 'user-item';

                    // Sanitize permissions and other strings for data attribute
                    const roleDataJson = JSON.stringify(role).replace(/'/g, "&apos;");

                    roleItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar-sm" style="background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);">
                            <i class="bi bi-key"></i>
                        </div>
                        <div>
                            <div class="user-name">${role.role_name} ${isSystemRole ? '<small class="text-muted">(System)</small>' : ''}</div>
                            <div class="user-email">${role.description || 'No description'}</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="role-badge role-badge-analyst me-2">${role.permissions ? role.permissions.length : 0} permissions</span>
                        <button class="btn btn-sm btn-outline-info edit-role-btn" 
                                data-role='${roleDataJson}'
                                title="Edit Role">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-role-btn" 
                                data-role-id="${role.role_id}" 
                                data-role-name="${role.role_name}"
                                ${isSystemRole ? 'disabled title="System roles cannot be deleted"' : 'title="Delete Role"'}>
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                    roleList.appendChild(roleItem);
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-role-btn').forEach(btn => {
                    btn.onclick = function () {
                        const data = JSON.parse(this.getAttribute('data-role'));
                        showEditRoleModal(data.role_id, data.role_name, data.description, JSON.stringify(data.permissions));
                    };
                });

                document.querySelectorAll('.delete-role-btn').forEach(btn => {
                    btn.onclick = function () {
                        const id = this.getAttribute('data-role-id');
                        const name = this.getAttribute('data-role-name');
                        deleteRole(id, name);
                    };
                });
            })
            .catch(error => console.error('Error loading roles:', error));
    }



    function loadAuditLog() {
        fetch('/api/security/audit-log')
            .then(response => response.json())
            .then(logs => {
                const auditLog = document.getElementById('audit-log');
                auditLog.innerHTML = '';

                if (logs.length === 0) {
                    auditLog.innerHTML = `
                    <div class="empty-audit-state">
                        <div class="empty-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <h5>No Audit Activity</h5>
                        <p>Security audit logs will appear here once users start interacting with the system.</p>
                    </div>
                `;
                    return;
                }

                // Create card-based layout for audit log
                const logContainer = document.createElement('div');
                logContainer.className = 'audit-log-container';

                logs.slice(0, 10).forEach(log => {
                    const logCard = createAuditLogCard(log);
                    logContainer.appendChild(logCard);
                });

                auditLog.appendChild(logContainer);
            })
            .catch(error => console.error('Error loading audit log:', error));
    }

    function createAuditLogCard(log) {
        const card = document.createElement('div');
        const iconClass = getActionIconClass(log.action);
        const actionLabel = getActionLabel(log.action);
        const formattedTime = formatAuditTime(log.timestamp);

        card.className = 'audit-card';
        card.innerHTML = `
        <div class="audit-icon-action ${iconClass}">
            ${getActionIconOnly(log.action)}
        </div>
        <div class="audit-content">
            <div class="audit-header">
                <span class="audit-action-text">${actionLabel}</span>
                <span class="audit-time"><i class="bi bi-clock me-1"></i>${formattedTime}</span>
            </div>
            <div class="audit-details">
                <span class="table-name">${log.table_name || 'System'}</span>
                ${log.record_id ? `<span class="record-id">ID: ${log.record_id}</span>` : ''}
            </div>
            <div class="audit-user-badge">
                <i class="bi bi-person-circle"></i>
                <span>${log.username || 'System'}</span>
            </div>
        </div>
    `;

        return card;
    }

    function getActionIconClass(action) {
        const classes = {
            'CREATE': 'audit-icon-create',
            'UPDATE': 'audit-icon-update',
            'DELETE': 'audit-icon-delete',
            'LOGIN': 'audit-icon-login',
            'FAILED_LOGIN': 'audit-icon-failed',
            'BACKUP': 'audit-icon-login',
            'SECURITY_INIT': 'audit-icon-create'
        };
        return classes[action] || 'audit-icon-default';
    }

    function getActionLabel(action) {
        const labels = {
            'CREATE': 'Created',
            'UPDATE': 'Updated',
            'DELETE': 'Deleted',
            'LOGIN': 'Login',
            'FAILED_LOGIN': 'Failed Login',
            'BACKUP': 'Backup',
            'SECURITY_INIT': 'Security Setup'
        };
        return labels[action] || action;
    }

    function getActionIconOnly(action) {
        const icons = {
            'CREATE': '<i class="bi bi-plus-circle"></i>',
            'UPDATE': '<i class="bi bi-pencil-square"></i>',
            'DELETE': '<i class="bi bi-trash"></i>',
            'LOGIN': '<i class="bi bi-box-arrow-in-right"></i>',
            'FAILED_LOGIN': '<i class="bi bi-x-circle"></i>',
            'BACKUP': '<i class="bi bi-cloud-download"></i>',
            'SECURITY_INIT': '<i class="bi bi-shield-check"></i>'
        };
        return icons[action] || '<i class="bi bi-gear"></i>';
    }

    function formatAuditTime(timestamp) {
        let date;

        // Handle different timestamp formats
        if (typeof timestamp === 'string') {
            // Check if timestamp has timezone info
            if (timestamp.includes('+') || timestamp.includes('-')) {
                // Parse timezone-aware timestamp
                const cleanTimestamp = timestamp.replace(/\.\d+/, ''); // Remove microseconds
                date = new Date(cleanTimestamp);
            } else {
                // Parse simple timestamp
                date = new Date(timestamp);
            }
        } else {
            // Handle numeric timestamp
            date = new Date(timestamp);
        }

        const localTime = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Add timezone information - use proper timezone detection
        const offset = date.getTimezoneOffset();
        const offsetHours = Math.floor(Math.abs(offset) / 60);
        const offsetMinutes = Math.abs(offset) % 60;
        const offsetSign = offset <= 0 ? '+' : '-';
        const timezoneStr = `UTC${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`;

        return `${localTime} (${timezoneStr})`;
    }

    function loadBackups() {
        fetch('/api/security/backups')
            .then(response => response.json())
            .then(backups => {
                const backupList = document.getElementById('backup-list');
                backupList.innerHTML = '';

                if (backups.length === 0) {
                    backupList.innerHTML = `
                    <div class="empty-backup-state">
                        <div class="empty-icon">
                            <i class="bi bi-cloud-download"></i>
                        </div>
                        <h5>No Backups Found</h5>
                        <p>Create your first backup to protect your database data.</p>
                    </div>
                `;
                    return;
                }

                // Create card-based layout for backups
                const backupContainer = document.createElement('div');
                backupContainer.className = 'backup-container';

                backups.forEach(backup => {
                    const backupCard = createBackupCard(backup);
                    backupContainer.appendChild(backupCard);
                });

                backupList.appendChild(backupContainer);
            })
            .catch(error => console.error('Error loading backups:', error));
    }

    function createBackupCard(backup) {
        const card = document.createElement('div');
        card.className = 'backup-item-card';

        const fileSize = formatFileSize(backup.file_size);
        const createdDate = formatBackupDate(backup.created_at);
        const iconClass = getBackupIconClass(backup.backup_type);

        card.innerHTML = `
        <div class="backup-icon-bg ${iconClass}">
            <i class="bi bi-cloud-download"></i>
        </div>
        <div class="backup-info-text">
            <div class="backup-filename">${backup.backup_filename}</div>
            <div class="backup-meta">
                <span class="role-badge role-badge-analyst">${backup.backup_type}</span>
                <span style="color: var(--text-muted);">${fileSize}</span>
                <span style="color: var(--text-muted);">â€¢</span>
                <span style="color: var(--text-muted);">${createdDate}</span>
            </div>
        </div>
        <div style="display: flex; gap: 8px;">
            <button class="btn-action-sm btn-download" onclick="downloadBackup('${backup.backup_path}')" title="Download">
                <i class="bi bi-download"></i>
            </button>
        </div>
    `;

        return card;
    }

    function getBackupIconClass(backupType) {
        const classes = {
            'Manual': 'backup-icon-manual',
            'Auto': 'backup-icon-auto',
            'Scheduled': 'backup-icon-scheduled'
        };
        return classes[backupType] || 'backup-icon-auto';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function formatBackupDate(timestamp) {
        let date;

        // Handle different timestamp formats
        if (typeof timestamp === 'string') {
            // Check if timestamp has timezone info
            if (timestamp.includes('+') || timestamp.includes('-')) {
                // Parse timezone-aware timestamp
                // Format: "2026-02-12 10:09:33.841827+07:00"
                const cleanTimestamp = timestamp.replace(/\.\d+/, ''); // Remove microseconds
                date = new Date(cleanTimestamp);
            } else {
                // Parse simple timestamp
                date = new Date(timestamp);
            }
        } else {
            // Handle numeric timestamp
            date = new Date(timestamp);
        }

        const localTime = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Add timezone information - use proper timezone detection
        const offset = date.getTimezoneOffset();
        const offsetHours = Math.floor(Math.abs(offset) / 60);
        const offsetMinutes = Math.abs(offset) % 60;
        const offsetSign = offset <= 0 ? '+' : '-';
        const timezoneStr = `UTC${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`;

        return `${localTime} (${timezoneStr})`;
    }

    function formatTimeWithTimezone(timestamp) {
        let date;

        // Handle different timestamp formats
        if (typeof timestamp === 'string') {
            // Check if timestamp has timezone info
            if (timestamp.includes('+') || timestamp.includes('-')) {
                // Parse timezone-aware timestamp
                const cleanTimestamp = timestamp.replace(/\.\d+/, ''); // Remove microseconds
                date = new Date(cleanTimestamp);
            } else {
                // Parse simple timestamp
                date = new Date(timestamp);
            }
        } else {
            // Handle numeric timestamp
            date = new Date(timestamp);
        }

        const localTime = date.toLocaleString();

        // Add timezone information - use proper timezone detection
        const offset = date.getTimezoneOffset();
        const offsetHours = Math.floor(Math.abs(offset) / 60);
        const offsetMinutes = Math.abs(offset) % 60;
        const offsetSign = offset <= 0 ? '+' : '-';
        const timezoneStr = `UTC${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`;

        return `${localTime} (${timezoneStr})`;
    }

    function getBackupIcon(backupType) {
        const icons = {
            'manual': '<div class="backup-icon backup-manual"><i class="bi bi-hand-index"></i></div>',
            'automatic': '<div class="backup-icon backup-auto"><i class="bi bi-arrow-repeat"></i></div>',
            'scheduled': '<div class="backup-icon backup-scheduled"><i class="bi bi-clock"></i></div>'
        };
        return icons[backupType] || '<div class="backup-icon backup-default"><i class="bi bi-cloud-download"></i></div>';
    }

    function downloadBackup(backupPath) {
        // Create a download link for the backup file
        const link = document.createElement('a');
        link.href = '/api/security/backup/download/' + encodeURIComponent(backupPath.split('/').pop());
        link.download = backupPath.split('/').pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showRoleModal() {
        document.getElementById('roleForm').reset();
        document.getElementById('edit_role_id').value = '';
        document.getElementById('roleModalTitle').textContent = 'Add Role';
        document.getElementById('saveRoleBtn').textContent = 'Create Role';
        const modal = new bootstrap.Modal(document.getElementById('roleModal'));
        modal.show();
    }

    function showEditRoleModal(roleId, roleName, description, permissions) {
        document.getElementById('roleForm').reset();
        document.getElementById('edit_role_id').value = roleId;
        document.getElementById('role_name').value = roleName;
        document.getElementById('role_description').value = description || '';
        document.getElementById('permissions').value = permissions;
        document.getElementById('roleModalTitle').textContent = 'Edit Role';
        document.getElementById('saveRoleBtn').textContent = 'Save Changes';
        const modal = new bootstrap.Modal(document.getElementById('roleModal'));
        modal.show();
    }

    function saveRole() {
        const roleId = document.getElementById('edit_role_id').value;
        const roleName = document.getElementById('role_name').value;
        const description = document.getElementById('role_description').value;
        const permissions = document.getElementById('permissions').value;

        if (!roleName) {
            alert('Role name is required');
            return;
        }

        const formData = new FormData();
        formData.append('role_name', roleName);
        formData.append('description', description);
        formData.append('permissions', permissions);

        const url = roleId ? `/api/security/roles/${roleId}` : '/api/security/roles';
        const method = roleId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('roleModal')).hide();
                    loadRoles();
                    alert(data.message);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error saving role:', error));
    }

    function deleteRole(roleId, roleName) {
        if (!confirm(`Are you sure you want to delete the role '${roleName}'? This action cannot be undone.`)) {
            return;
        }

        fetch(`/api/security/roles/${roleId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRoles();
                    alert('Role deleted successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error deleting role:', error));
    }


    function refreshAuditLog() {
        loadAuditLog();
    }

    function exportAuditLog() {
        fetch('/api/security/audit-log/export')
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'audit_log_' + new Date().toISOString().slice(0, 10) + '.csv';
                a.click();
            })
            .catch(error => console.error('Error exporting audit log:', error));
    }

    function refreshBackups() {
        loadBackups();
    }

    function createBackup() {
        fetch('/api/security/backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'backup_type=manual'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadBackups();
                    alert('âœ… Backup created successfully!');
                } else {
                    alert('âŒ Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error creating backup:', error));
    }

    function scheduleBackups() {
        fetch('/api/security/schedule-backups', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadBackups();
                    alert('Backup scheduling updated!');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error scheduling backups:', error));
    }

    function showInitModal() {
        const modal = new bootstrap.Modal(document.getElementById('initDatabaseModal'));
        modal.show();
    }

    function showMigrateModal() {
        const modal = new bootstrap.Modal(document.getElementById('migrateDatabaseModal'));
        modal.show();
    }

    function initDatabase() {
        const form = document.getElementById('initDatabaseForm');
        const formData = new FormData(form);

        fetch('/api/security/database/init', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('initDatabaseModal')).hide();
                    alert('âœ… Secure database created successfully!\n\n' + data.message);
                    checkDatabaseSecurityStatus();
                } else {
                    if (data.message && data.message.includes('already exists')) {
                        alert('âš ï¸ Database already exists!\n\n' + data.message + '\n\nPlease choose a different path or delete the existing database first.');
                    } else {
                        alert('âŒ Error: ' + data.message);
                    }
                }
            })
            .catch(error => console.error('Error initializing database:', error));
    }

    function migrateDatabase() {
        const form = document.getElementById('migrateDatabaseForm');
        const formData = new FormData(form);

        fetch('/api/security/database/migrate', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('migrateDatabaseModal')).hide();
                    alert('âœ… Security features added successfully!\n\n' + data.message);
                    checkDatabaseSecurityStatus();
                } else {
                    alert('âŒ Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error migrating database:', error));
    }

    function checkDatabaseSecurityStatus() {
        fetch('/api/security/database/status')
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('database-status');

                if (data.success) {
                    if (data.has_security) {
                        statusDiv.className = 'alert alert-success';
                        statusDiv.innerHTML = '<i class="bi bi-shield-check"></i><strong>Security Status:</strong> ' + data.message + '<br><small>Security tables: ' + data.security_tables.join(', ') + ' (' + data.table_count + ' tables)</small>';
                    } else {
                        statusDiv.className = 'alert alert-warning';
                        statusDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i><strong>Security Status:</strong> ' + data.message + '<br><small>Click "Add Security to Existing" to set up security features</small>';
                    }
                } else {
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.innerHTML = '<i class="bi bi-x-circle"></i><strong>Error:</strong> ' + data.message;
                }
            })
            .catch(error => console.error('Error checking database status:', error));
    }

    // Backup Scheduling Functions
    // Note: Backup scheduling removed - use standalone scheduler

    // Note: Backup status function removed - use standalone scheduler
    // Initialize backup status display
    const statusDiv = document.getElementById('backup-status');
    statusDiv.innerHTML = `
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>Automatic Backups:</strong> Use standalone scheduler<br>
        <small>Run 'start_automatic_backup.bat' to enable automatic backups</small>
    </div>
`;

    // Note: Backup scheduling functions removed - use standalone scheduler

    // Initialize database security status on page load
    document.addEventListener('DOMContentLoaded', function () {
        checkDatabaseSecurityStatus();
    });
</script>
{% endblock %}