{% extends "base.html" %}

{% block title %}AI Chat - HaoXai{% endblock %}

{% block extra_css %}
<style>
    /* WhatsApp-style chat container */
    .chat-container {
        height: calc(100vh - 116px);
        min-height: 600px;
        display: flex;
        flex-direction: column;
        background: #e5ddd5;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: relative;
        margin: 0;
    }
    
    /* WhatsApp-style header */
    .chat-header {
        background: #075e54;
        color: white;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        flex-shrink: 0;
    }
    
    .header-info {
        flex: 1;
    }
    
    .header-info h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 500;
    }
    
    .header-info p {
        margin: 0;
        font-size: 13px;
        opacity: 0.8;
    }
    
    .header-actions {
        display: flex;
        gap: 16px;
        align-items: center;
    }
    
    .header-actions button {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background 0.2s;
    }
    
    .header-actions button:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    /* WhatsApp-style messages area */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px 12px;
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjZTVkZGQ1Ii8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0idXJsKCNwYXR0ZXJuKSIvPjwvc3ZnPg==');
        background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjZTVkZGQ1Ii8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0idXJsKCNwYXR0ZXJuKSIvPjwvc3ZnPg==');
        position: relative;
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }
    
    /* WhatsApp-style message bubbles */
    .message {
        margin-bottom: 8px;
        max-width: 75%;
        word-wrap: break-word;
        position: relative;
        font-size: 15px;
        line-height: 1.4;
        animation: messageSlide 0.3s ease-out;
        clear: both;
    }
    
    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* User messages (right side, green) */
    .user-message {
        float: right;
        background: #dcf8c6;
        color: #303030;
        padding: 8px 12px;
        border-radius: 7.5px;
        border-top-right-radius: 0;
        position: relative;
        margin-left: auto;
    }
    
    .user-message::after {
        content: '';
        position: absolute;
        top: 0;
        right: -8px;
        width: 8px;
        height: 12px;
        background: #dcf8c6;
        border-radius: 0 8px 0 0;
        clip-path: polygon(0 0, 100% 0, 0 100%);
    }
    
    /* AI messages (left side, white/gray) */
    .ai-message {
        float: left;
        background: white;
        color: #303030;
        padding: 8px 12px;
        border-radius: 7.5px;
        border-top-left-radius: 0;
        position: relative;
        margin-right: auto;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }
    
    .ai-message::after {
        content: '';
        position: absolute;
        top: 0;
        left: -8px;
        width: 8px;
        height: 12px;
        background: white;
        border-radius: 8px 0 0 0;
        clip-path: polygon(0 0, 100% 0, 100% 100%);
        box-shadow: -1px 1px 0.5px rgba(0, 0, 0, 0.13);
    }
    
    .message-text {
        margin-bottom: 4px;
    }
    
    .message-time {
        font-size: 11px;
        color: #999;
        float: right;
        margin-top: 2px;
    }
    
    .user-message .message-time {
        color: #4fc3f7;
    }
    
    /* WhatsApp-style input area */
    .chat-input-container {
        padding: 8px 12px;
        background: #f0f2f5;
        border-top: 1px solid #ddd;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .input-group {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 100%;
    }
    
    .chat-input {
        flex: 1;
        background: white;
        border: 1px solid #ddd;
        color: #303030;
        padding: 10px 12px;
        border-radius: 20px;
        font-size: 15px;
        transition: all 0.2s ease;
        outline: none;
    }
    
    .chat-input:focus {
        border-color: #008069;
        box-shadow: 0 0 0 2px rgba(0, 128, 105, 0.1);
    }
    
    .chat-input::placeholder {
        color: #999;
    }
    
    /* WhatsApp-style action buttons */
    .action-button {
        background: none;
        border: none;
        color: #54656f;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    .action-button:hover {
        background: rgba(0, 0, 0, 0.05);
        color: #303030;
    }
    
    .send-button {
        background: #008069;
        color: white;
        font-size: 18px;
    }
    
    .send-button:hover {
        background: #00695c;
    }
    
    .send-button:disabled {
        background: #ccc;
        color: #999;
        cursor: not-allowed;
    }
    
    /* Typing indicator */
    .typing-indicator {
        display: none;
        color: #667eea;
        font-style: italic;
        padding: 8px 12px;
        font-size: 13px;
        background: white;
        border-radius: 7.5px;
        border-top-left-radius: 0;
        max-width: 75%;
        float: left;
        margin-right: auto;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }
    
    .typing-dots {
        display: inline-block;
        animation: typing 1.5s infinite;
    }
    
    @keyframes typing {
        0%, 60%, 100% { opacity: 0.3; }
        30% { opacity: 1; }
    }
    
    .typing-dots::after {
        content: '...';
    }
    
    /* Chat info styling */
    .chat-info {
        background: rgba(0, 128, 105, 0.1);
        border: 1px solid rgba(0, 128, 105, 0.2);
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 12px;
        color: #008069;
        font-size: 14px;
        line-height: 1.4;
        clear: both;
        max-width: 85%;
        margin-left: auto;
        margin-right: auto;
    }
    
    .preformatted-text {
        white-space: pre-wrap;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        font-size: 15px;
        line-height: 1.4;
        margin: 0;
    }
    
    /* Excel upload styling */
    .excel-upload-input {
        display: none;
    }
    
    .excel-upload-btn {
        background: none;
        border: none;
        color: #54656f;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        <div class="col-12">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="profile-pic">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="header-info">
                        <h3>HaoXai AI Assistant</h3>
                        <p>Online ‚Ä¢ Ask me about your virology database</p>
                    </div>
                    <div class="header-actions">
                        <button title="Video call"><i class="fas fa-video"></i></button>
                        <button title="Search"><i class="fas fa-search"></i></button>
                        <button title="More options"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-info">
                        <strong><i class="fas fa-info-circle me-2"></i>Welcome to HaoXai AI Chat!</strong>
                        <br>I can help you find sample information, screening results, storage locations, and more.
                        <br>Try asking: "Find information for sample CANB_ANA25_001"
                    </div>
                    
                    <div class="ai-message">
                        <div class="preformatted-text">Hello! I'm your HaoXai AI assistant. I can help you:

üîç Find sample information:
- "Find information for sample CANB_ANA25_001"
- "Where is sample CANB_ANA24_1102 stored?"
- "What is the scientific name of sample CANB_ANA25_001?"

üìä Database statistics:
- "How many samples are in the database?"
- "How many positive Corona tests were found?"
- "What bat species are most common?"

üåç Location and species data:
- "Which provinces have samples?"
- "What are the screening statistics?"

What would you like to know about your {{ db_name }} database?</div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <span class="typing-dots"></span> AI is thinking...
                </div>
                
                <div class="chat-input-container">
                    <div class="input-group">
                        <button class="action-button" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="excelFile" class="excel-upload-input" accept=".xlsx,.xls">
                        <button class="action-button" onclick="document.getElementById('excelFile').click()" title="Upload Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                        <input type="text" id="questionInput" class="chat-input" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
                        <button class="action-button" title="Emoji">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="action-button" title="Voice note">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="send-button action-button" onclick="askQuestion()" id="sendBtn" title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="action-button" onclick="downloadResults()" id="downloadBtn" style="display: none; background: #008069; color: white;" title="Download results">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div id="uploadStatus" class="mt-2 text-center"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const chatMessages = $('#chatMessages');
    const chatInput = $('#questionInput');
    const sendButton = $('#sendButton');
    const typingIndicator = $('#typingIndicator');
    
    // Auto-focus input
    chatInput.focus();
    
    // Send message on Enter
    chatInput.keypress(function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Send message on button click
    sendButton.click(sendMessage);
    
    // Auto-upload when file is selected
    $('#excelFile').change(function() {
        if (this.files.length > 0) {
            uploadSampleList();
        }
    });
    
        
    // Send message
    function sendMessage() {
        const message = chatInput.val().trim();
        if (!message) return;
        
        // Add user message
        addMessage(message, 'user');
        
        // Clear input
        chatInput.val('');
        
        // Show typing indicator
        typingIndicator.show();
        scrollToBottom();
        
        // Send to server
        fetch('/chat/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question: message
            })
        })
        .then(response => response.json())
        .then(data => {
            typingIndicator.hide();
            
            if (data.success) {
                addMessage(data.answer, 'ai');
            } else {
                addMessage('Sorry, I encountered an error: ' + data.answer, 'ai');
            }
        })
        .catch(error => {
            typingIndicator.hide();
            addMessage('Sorry, I encountered a network error. Please try again.', 'ai');
        });
    }
    
    // Add message to chat
    function addMessage(text, sender) {
        const messageDiv = $('<div>').addClass('message').addClass(sender + '-message');
        
        // Check if text contains HTML (table format)
        if (text.includes('<table>')) {
            const textDiv = $('<div>').html(text);
            messageDiv.append(textDiv);
        } else {
            const textDiv = $('<div>').addClass('preformatted-text').text(text);
            messageDiv.append(textDiv);
        }
        
        // Add timestamp
        const timeDiv = $('<div>').addClass('message-time').text(getCurrentTime());
        messageDiv.append(timeDiv);
        
        chatMessages.append(messageDiv);
        scrollToBottom();
    }
    
    // Scroll to bottom
    function scrollToBottom() {
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    }
    
    // Get current time
    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // Initial scroll to bottom
    scrollToBottom();
});

// Global functions for HTML onclick handlers
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
    }
}

function askQuestion() {
    sendMessage();
}

function sendMessage() {
    const chatInput = $('#questionInput');
    const message = chatInput.val().trim();
    if (!message) return;
    
    // Add user message
    addMessage(message, 'user');
    
    // Clear input
    chatInput.val('');
    
    // Show typing indicator
    $('#typingIndicator').show();
    scrollToBottom();
    
    // Send to server
    fetch('/chat/ask', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            question: message
        })
    })
    .then(response => response.json())
    .then(data => {
        $('#typingIndicator').hide();
        
        if (data.success) {
            addMessage(data.answer, 'ai');
        } else {
            addMessage('Sorry, I encountered an error: ' + data.answer, 'ai');
        }
    })
    .catch(error => {
        $('#typingIndicator').hide();
        addMessage('Sorry, I encountered a network error. Please try again.', 'ai');
    });
}

function addMessage(text, sender) {
    const messageDiv = $('<div>').addClass('message').addClass(sender + '-message');
    
    // Check if text contains HTML (table format)
    if (text.includes('<table>')) {
        const textDiv = $('<div>').html(text);
        messageDiv.append(textDiv);
    } else {
        const textDiv = $('<div>').addClass('preformatted-text').text(text);
        messageDiv.append(textDiv);
    }
    
    // Add timestamp
    const timeDiv = $('<div>').addClass('message-time').text(getCurrentTime());
    messageDiv.append(timeDiv);
    
    $('#chatMessages').append(messageDiv);
    scrollToBottom();
}

function scrollToBottom() {
    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
}

function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
</script>
{% endblock %}

